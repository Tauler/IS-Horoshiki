<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd">

    <changeSet id="06112016-1" author="prohoroven">
        <sql>
        ALTER TABLE [dbo].[AspNetUsers] ADD [SubDepartmentId] INT NULL
        </sql>
    </changeSet>

    <changeSet id="06112016-2" author="prohoroven">
        <sql>
        ALTER TABLE [dbo].[AspNetUsers]  WITH CHECK ADD  CONSTRAINT [FK_dbo.AspNetUsers_dbo.SubDepartments_SubDepartmentId] FOREIGN KEY([SubDepartmentId])
	REFERENCES [dbo].[SubDepartments] ([Id])
        </sql>
    </changeSet>

    <changeSet id="06112016-3" author="prohoroven">
        <sql>
        ALTER TABLE [dbo].[AspNetUsers] CHECK CONSTRAINT [FK_dbo.AspNetUsers_dbo.SubDepartments_SubDepartmentId]
        </sql>
    </changeSet>
	
	<changeSet id="18112016_1" author="prohoroven">
        <sql>
			CREATE TABLE [dbo].[ShiftPersonalSchedules](
				[Id] [int] IDENTITY(1,1) NOT NULL,
				[UserId]	  [int] NOT NULL,
				[ShiftTypeId] [int] NOT NULL,
				[Date] datetime NOT NULL
			 CONSTRAINT [PK_dbo.ShiftPersonalSchedules] PRIMARY KEY CLUSTERED 
			(
				[Id] ASC
			)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
			) ON [PRIMARY]
        </sql>
    </changeSet>
	
	<changeSet id="18112016_2" author="prohoroven">
        <sql>
			ALTER TABLE [dbo].[ShiftPersonalSchedules]  WITH CHECK ADD  CONSTRAINT [FK_dbo.ShiftPersonalSchedules_dbo.AspNetUsers_UserId] FOREIGN KEY([UserId])
			REFERENCES [dbo].[AspNetUsers] ([Id])
			ON DELETE CASCADE
        </sql>
    </changeSet>
	
	<changeSet id="18112016_3" author="prohoroven">
        <sql>
			ALTER TABLE [dbo].[ShiftPersonalSchedules] CHECK CONSTRAINT [FK_dbo.ShiftPersonalSchedules_dbo.AspNetUsers_UserId]
        </sql>
    </changeSet>

	<changeSet id="18112016_4" author="prohoroven">
        <sql>
			ALTER TABLE [dbo].[ShiftPersonalSchedules]  WITH CHECK ADD  CONSTRAINT [FK_dbo.ShiftPersonalSchedules_dbo.ShiftTypes_ShiftTypeId] FOREIGN KEY([ShiftTypeId])
			REFERENCES [dbo].[ShiftTypes] ([Id])
			ON DELETE CASCADE
        </sql>
    </changeSet>
	
	<changeSet id="18112016_5" author="prohoroven">
        <sql>
			ALTER TABLE [dbo].[ShiftPersonalSchedules] CHECK CONSTRAINT [FK_dbo.ShiftPersonalSchedules_dbo.ShiftTypes_ShiftTypeId]
        </sql>
    </changeSet>
	
	<changeSet id="18112016_6" author="prohoroven">
        <sql>
			CREATE TABLE [dbo].[ShiftPersonalSchedulePeriods](
				[Id] [int] IDENTITY(1,1) NOT NULL,
				[ShiftPersonalScheduleId] [int] NOT NULL,
				[StartTime] [time](7) NOT NULL,
				[StopTime] [time](7) NOT NULL,
			 CONSTRAINT [PK_dbo.ShiftPersonalSchedulePeriods] PRIMARY KEY CLUSTERED 
			(
				[Id] ASC
			)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
			) ON [PRIMARY]
        </sql>
    </changeSet>
	
	<changeSet id="18112016_7" author="prohoroven">
        <sql>
			ALTER TABLE [dbo].[ShiftPersonalSchedulePeriods]  WITH CHECK ADD  CONSTRAINT [FK_dbo.ShiftPersonalSchedulePeriods_dbo.ShiftPersonalSchedules_ShiftPersonalScheduleId] FOREIGN KEY([ShiftPersonalScheduleId])
			REFERENCES [dbo].[ShiftPersonalSchedules] ([Id])
			ON DELETE CASCADE
        </sql>
    </changeSet>
	
     <changeSet id="18112016_8" author="prohoroven">
        <sql>
			ALTER TABLE [dbo].[ShiftPersonalSchedulePeriods] CHECK CONSTRAINT [FK_dbo.ShiftPersonalSchedulePeriods_dbo.ShiftPersonalSchedules_ShiftPersonalScheduleId]
        </sql>
    </changeSet>
	
	<changeSet id="18112016_9" author="prohoroven">
        <comment>Функция создания таблицы периода дат</comment>
        <sqlFile path="./sql/stored_procedures_branch_iteration_4.2/2016-11-07_Function_GetDateRange.sql"/>
    </changeSet>
	
	<changeSet id="18112016_10" author="prohoroven">
        <comment>Создание входного типа список Id для ХП</comment>
        <sqlFile path="./sql/stored_procedures_branch_iteration_4.2/2016-11-07_Custom_type_IdList.sql"/>
    </changeSet>
	
	<changeSet id="18112016_11" author="prohoroven">
        <comment>Создание таблицы графика смен персонала</comment>
        <sqlFile path="./sql/stored_procedures_branch_iteration_4.2/2016-11-07_ScheduleShiftPersonal.sql"/>
    </changeSet>
	
	<changeSet id="20112016_1" author="prohoroven">
        <comment>Скалярная функция подсчета нормачасов для пользователя</comment>
        <sqlFile path="./sql/stored_procedures_branch_iteration_4.2/2016-11-20_1_Function_GetScheduleShiftPersonalNormaHour.sql"/>
    </changeSet>
	
	<changeSet id="20112016_2" author="prohoroven">
        <comment>Создание таблицы графика смен персонала</comment>
        <sqlFile path="./sql/stored_procedures_branch_iteration_4.2/2016-11-20_2_ALTER_ScheduleShiftPersonal.sql"/>
    </changeSet>

    <changeSet id="22112016_1" author="prohoroven">
        <comment>Скалярная функция подсчета нормачасов для пользователя</comment>
        <sqlFile path="./sql/stored_procedures_branch_iteration_4.2/2016-11-22_1_ALTER_GetScheduleShiftPersonalNormaHour.sql"/>
    </changeSet>
	
    <changeSet id="22112016_2" author="prohoroven">
        <comment>Создание таблицы графика смен персонала</comment>
        <sqlFile path="./sql/stored_procedures_branch_iteration_4.2/2016-11-22_2_ALTER_ScheduleShiftPersonal.sql"/>
    </changeSet>

    <changeSet id="26112016_1" author="prohoroven">
        <comment>Скалярная функция подсчета нормачасов для пользователя</comment>
        <sqlFile path="./sql/stored_procedures_branch_iteration_4.2/2016-11-26_1_ALTER_GetScheduleShiftPersonalNormaHour.sql"/>
    </changeSet>
	
    <changeSet id="26112016_22" author="prohoroven">
        <comment>Создание таблицы графика смен персонала</comment>
        <sqlFile path="./sql/stored_procedures_branch_iteration_4.2/2016-11-26_2_ALTER_ScheduleShiftPersonal.sql"/>
    </changeSet>

    <changeSet id="26112016_3" author="prohoroven">
        <sql>
		INSERT INTO [dbo].[Positions] ([Guid] ,[Value]) VALUES ('F023CCAF-A518-4857-B352-528250B9DD23' , 'Уборщик')
        </sql>
    </changeSet>
    <changeSet id="28112016" author="prohoroven">
        <sql>
		INSERT INTO [dbo].[Positions] ([Guid] ,[Value]) VALUES ('ADBD797D-3253-4209-828B-92161C267E45' , 'Оператор')
        </sql>
    </changeSet>
    <changeSet id="05122016" author="prohoroven">
        <sql>
	CREATE TABLE [dbo].[PlanTypes](
		[Id]	[int] IDENTITY(1,1) NOT NULL,
		[Guid]	[uniqueidentifier]	NOT NULL,
		[Value] [nvarchar](100)		NOT NULL,
 	CONSTRAINT [PK_dbo.PlanTypes] PRIMARY KEY CLUSTERED 
	(
		[Id] ASC
	)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
	) ON [PRIMARY]
	</sql>
    </changeSet>
    <changeSet id="05122016_2" author="prohoroven">
        <sql>
	INSERT INTO [dbo].[PlanTypes] ([Guid],[Value]) VALUES ('D4C8C9C0-EA2F-47B6-8156-3030153AB8F4', 'Суши');

	INSERT INTO [dbo].[PlanTypes] ([Guid],[Value]) VALUES ('5DE8DA4E-8E06-47B9-975E-354BAF1D41CE', 'Пицца');
	</sql>
    </changeSet>
    <changeSet id="05122016_4" author="prohoroven">
        <sql>
	ALTER TABLE [dbo].[SalePlans]  WITH CHECK ADD  CONSTRAINT [FK_dbo.SalePlans_dbo.PlanTypes_PlanTypeId] FOREIGN KEY([PlanTypeId])
	REFERENCES [dbo].[PlanTypes] ([Id])
	ON DELETE CASCADE
        </sql>
    </changeSet>
    <changeSet id="05122016_5" author="prohoroven">
        <sql>
	DELETE FROM [dbo].[SubDepartments_SaleChecks_Link]


	INSERT INTO [dbo].[SubDepartments_SaleChecks_Link]
	(
		[SaleCheckId],
		[SubDepartmentId]
	)
	SELECT
		sc.[Id],
		(SELECT Id FROM [dbo].[SubDepartments] WHERE Guid = 'FCD7586F-EDDB-4531-BE83-E006BEB766D3')
  	FROM
		dbo.IntegrationChecks ic
  	INNER JOIN dbo.SaleChecks sc ON SC.IdCheck = ic.[IdCheck] 
  	WHERE 
		ic.IsSushiSubDepartment = 1 and
		ic.Id = (
				SELECT 
						MAX(Id)
				  FROM
						dbo.IntegrationChecks ic2
				 WHERE
						ic2.IdCheck = ic.IdCheck  
			)


	INSERT INTO [dbo].[SubDepartments_SaleChecks_Link]
	(
		[SaleCheckId],
		[SubDepartmentId]
	)	
	SELECT
		sc.[Id],
		(SELECT Id FROM [dbo].[SubDepartments] WHERE Guid = 'F2E916DC-21BB-47FB-8863-7ACF15DAAB02')
	  FROM
		dbo.IntegrationChecks ic
	  INNER JOIN dbo.SaleChecks sc ON SC.IdCheck = ic.[IdCheck] 
	  WHERE 
		ic.[IsCoolSubDepartment] = 1 and
		ic.Id = (
				SELECT 
						MAX(Id)
				  FROM
						dbo.IntegrationChecks ic2
				 WHERE
						ic2.IdCheck = ic.IdCheck  
			)


	INSERT INTO [dbo].[SubDepartments_SaleChecks_Link]
	(
		[SaleCheckId],
		[SubDepartmentId]
	)
	SELECT
		sc.[Id],
		(SELECT Id FROM [dbo].[SubDepartments] WHERE Guid = '4A1872B9-D334-4878-A895-0E4D2E7CDA70')
	  FROM
		dbo.IntegrationChecks ic
	  INNER JOIN dbo.SaleChecks sc ON SC.IdCheck = ic.[IdCheck] 
	  WHERE 
		ic.[IsPizzaSubDepartment] = 1 and
		ic.Id = (
				SELECT 
						MAX(Id)
				  FROM
						dbo.IntegrationChecks ic2
				 WHERE
						ic2.IdCheck = ic.IdCheck  
			)
	</sql>
    </changeSet>
	<changeSet id="06122016_1" author="prohoroven">
        <comment>Подсчет чеков плана продаж на основе среднего</comment>
        <sqlFile path="./sql/stored_procedures_branch_iteration_4.2/2016-12-06_GetSalePlanAverageForScheduleShift.sql"/>
    </changeSet>
	<changeSet id="06122016_2" author="prohoroven">
        <comment>Подсчет чеков плана продаж в зависимости от отдела</comment>
        <sqlFile path="./sql/stored_procedures_branch_iteration_4.2/2016-12-06_GetSalePlanForScheduleShift.sql"/>
    </changeSet>
</databaseChangeLog>







